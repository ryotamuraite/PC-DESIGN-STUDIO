# Issue & Project Management Automation
# Issueç®¡ç†ã€ãƒ©ãƒ™ãƒ«ä»˜ã‘ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚’è‡ªå‹•åŒ–

name: ğŸ“‹ Project Management

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, edited, labeled, unlabeled, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  # æ–°ã—ã„Issueã®è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘
  auto-label-issues:
    name: ğŸ·ï¸ Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: ğŸ·ï¸ Apply labels based on issue content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';
            
            const labels = [];
            
            // æ©Ÿèƒ½è¿½åŠ 
            if (title.includes('feature') || title.includes('æ©Ÿèƒ½') || body.includes('æ–°æ©Ÿèƒ½')) {
              labels.push('enhancement');
            }
            
            // ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ
            if (title.includes('bug') || title.includes('ãƒã‚°') || title.includes('ã‚¨ãƒ©ãƒ¼')) {
              labels.push('bug');
            }
            
            // UI/UXã«é–¢ã™ã‚‹å†…å®¹
            if (title.includes('ui') || title.includes('ux') || body.includes('ãƒ‡ã‚¶ã‚¤ãƒ³')) {
              labels.push('ui/ux');
            }
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            if (title.includes('performance') || title.includes('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹') || title.includes('é€Ÿåº¦')) {
              labels.push('performance');
            }
            
            // æ¤œç´¢æ©Ÿèƒ½
            if (title.includes('search') || title.includes('æ¤œç´¢')) {
              labels.push('search');
            }
            
            // é›»åŠ›è¨ˆç®—
            if (title.includes('power') || title.includes('é›»åŠ›') || title.includes('é›»æº')) {
              labels.push('power-calculation');
            }
            
            // äº’æ›æ€§
            if (title.includes('compatibility') || title.includes('äº’æ›æ€§')) {
              labels.push('compatibility');
            }
            
            // å„ªå…ˆåº¦ã®è‡ªå‹•åˆ¤å®š
            if (title.includes('urgent') || title.includes('ç·Šæ€¥') || body.includes('é‡è¦')) {
              labels.push('priority: high');
            } else if (title.includes('nice to have') || body.includes('ã§ãã‚Œã°')) {
              labels.push('priority: low');
            } else {
              labels.push('priority: medium');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  # PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã®è‡ªå‹•åŒ–
  auto-request-review:
    name: ğŸ‘€ Auto Request Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: ğŸ‘€ Request review from team
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // PRã®ã‚µã‚¤ã‚ºã«åŸºã¥ããƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼æ±ºå®š
            const changedFiles = pr.changed_files;
            const additions = pr.additions;
            const deletions = pr.deletions;
            
            let reviewers = [];
            
            // å¤§ããªå¤‰æ›´ã®å ´åˆã¯è¤‡æ•°äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚
            if (changedFiles > 10 || additions + deletions > 500) {
              reviewers = ['team-lead', 'senior-dev']; // å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«å¤‰æ›´
            } else {
              reviewers = ['team-member']; // å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«å¤‰æ›´
            }
            
            // ãƒ©ãƒ™ãƒ«ã‚‚è¿½åŠ 
            const labels = [];
            if (changedFiles > 10) {
              labels.push('size: large');
            } else if (changedFiles > 3) {
              labels.push('size: medium');
            } else {
              labels.push('size: small');
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ï¼ˆå®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: reviewers
              });
            } catch (error) {
              console.log('ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã®è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
            }
            
            // ãƒ©ãƒ™ãƒ«è¿½åŠ 
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
            }

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
  schedule-maintenance:
    name: ğŸ”§ Scheduled Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§¹ Close stale issues
        uses: actions/stale@v9
        with:
          stale-issue-message: |
            ã“ã®Issueã¯30æ—¥é–“æ´»å‹•ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«staleãƒãƒ¼ã‚¯ãŒä»˜ã‘ã‚‰ã‚Œã¾ã—ãŸã€‚
            ã¾ã é–¢é€£æ€§ãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¦ãã ã•ã„ã€‚
            ã•ã‚‰ã«7æ—¥å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚
          close-issue-message: |
            ã“ã®Issueã¯é•·æœŸé–“æ´»å‹•ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚
            å¿…è¦ã«å¿œã˜ã¦å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ãã ã•ã„ã€‚
          stale-pr-message: |
            ã“ã®PRã¯30æ—¥é–“æ´»å‹•ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«staleãƒãƒ¼ã‚¯ãŒä»˜ã‘ã‚‰ã‚Œã¾ã—ãŸã€‚
          close-pr-message: |
            ã“ã®PRã¯é•·æœŸé–“æ´»å‹•ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚
          days-before-stale: 30
          days-before-close: 7
          exempt-issue-labels: 'pinned,security'
          exempt-pr-labels: 'pinned'

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆé€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼‰
on:
  schedule:
    - cron: '0 3 * * 1'  # æ¯é€±æœˆæ›œæ—¥ UTC 3:00 AM
