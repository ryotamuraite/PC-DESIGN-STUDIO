# Data Update & External API Integration
# å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®æƒ…å ±å–å¾—ã¨æ›´æ–°

name: ğŸ“Š Data Update

on:
  schedule:
    # æ¯æ—¥ JST 11:00 (UTC 02:00) ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°'
        required: false
        default: 'false'
        type: boolean
      target_category:
        description: 'æ›´æ–°å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cpu
          - gpu
          - motherboard
          - memory
          - storage
          - psu

env:
  NODE_ENV: production
  DATA_UPDATE_INTERVAL: 24h
  MAX_RETRIES: 3

jobs:
  # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
  health-check:
    name: ğŸ¥ Data Source Health Check
    runs-on: ubuntu-latest
    outputs:
      sources-available: ${{ steps.check.outputs.available }}
    steps:
      - name: ğŸ¥ Check external API availability
        id: check
        run: |
          echo "å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # å®Ÿéš›ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
          # response=$(curl -s -o /dev/null -w "%{http_code}" https://api.example.com/health)
          # if [ $response -eq 200 ]; then
          #   echo "available=true" >> $GITHUB_OUTPUT
          # else
          #   echo "available=false" >> $GITHUB_OUTPUT
          # fi
          
          # ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆå®Ÿè£…æ™‚ã«å®Ÿéš›ã®ãƒã‚§ãƒƒã‚¯ã«ç½®ãæ›ãˆï¼‰
          echo "available=true" >> $GITHUB_OUTPUT

  # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†
  update-parts-data:
    name: ğŸ“¦ Update Parts Database
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.sources-available == 'true'
    strategy:
      matrix:
        category: [cpu, gpu, motherboard, memory, storage, psu, case, cooler]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ“Š Update ${{ matrix.category }} data
        run: |
          echo "ğŸ”„ ${{ matrix.category }} ã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­..."
          
          # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆä¾‹ï¼‰
          # node scripts/update-data.js --category=${{ matrix.category }}
          
          # ãƒ¢ãƒƒã‚¯å‡¦ç†ï¼ˆå®Ÿè£…æ™‚ã«å®Ÿéš›ã®å‡¦ç†ã«ç½®ãæ›ãˆï¼‰
          echo "{}" > "src/data/updated-${{ matrix.category }}.json"
          echo "âœ… ${{ matrix.category }} ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"

      - name: ğŸ“Š Upload updated data
        uses: actions/upload-artifact@v4
        with:
          name: updated-data-${{ matrix.category }}
          path: src/data/updated-${{ matrix.category }}.json
          retention-days: 1

  # ãƒ‡ãƒ¼ã‚¿çµ±åˆã¨ã‚³ãƒŸãƒƒãƒˆ
  commit-updated-data:
    name: ğŸ’¾ Commit Updated Data
    runs-on: ubuntu-latest
    needs: update-parts-data
    if: always() && needs.update-parts-data.result == 'success'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download all updated data
        uses: actions/download-artifact@v4
        with:
          path: updated-data/

      - name: ğŸ”„ Merge updated data
        run: |
          echo "ğŸ”„ æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­..."
          
          # æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆ
          for file in updated-data/*/updated-*.json; do
            if [ -f "$file" ]; then
              category=$(basename "$file" | sed 's/updated-\(.*\)\.json/\1/')
              echo "çµ±åˆä¸­: $category"
              # å®Ÿéš›ã®çµ±åˆå‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
              # jq '.data += input' src/data/main.json "$file" > tmp.json && mv tmp.json src/data/main.json
            fi
          done
          
          echo "âœ… ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†"

      - name: ğŸ“Š Generate update summary
        run: |
          echo "ğŸ“Š æ›´æ–°ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆä¸­..."
          
          # æ›´æ–°ã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
          cat > UPDATE_SUMMARY.md << EOF
          # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚µãƒãƒªãƒ¼
          
          **æ›´æ–°æ—¥æ™‚**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
          
          ## æ›´æ–°ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒª
          EOF
          
          for file in updated-data/*/updated-*.json; do
            if [ -f "$file" ]; then
              category=$(basename "$file" | sed 's/updated-\(.*\)\.json/\1/')
              echo "- âœ… $category" >> UPDATE_SUMMARY.md
            fi
          done
          
          echo "" >> UPDATE_SUMMARY.md
          echo "## æ¬¡å›æ›´æ–°äºˆå®š" >> UPDATE_SUMMARY.md
          echo "$(date -u -d '+1 day' +"%Y-%m-%d %H:%M:%S UTC")" >> UPDATE_SUMMARY.md

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [Data Update]"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ“Š Auto-update parts data $(date -u +"%Y-%m-%d")"
            git push
            echo "âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ æ›´æ–°å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãªã—"
          fi

  # ã‚¨ãƒ©ãƒ¼é€šçŸ¥
  notify-on-failure:
    name: ğŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [health-check, update-parts-data, commit-updated-data]
    if: failure()
    steps:
      - name: ğŸ“¢ Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ (${new Date().toISOString().split('T')[0]})`;
            const body = `
            ## ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼
            
            **ç™ºç”Ÿæ—¥æ™‚**: ${new Date().toISOString()}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}
            **å®Ÿè¡ŒID**: ${{ github.run_id }}
            
            ### ã‚¨ãƒ©ãƒ¼è©³ç´°
            - Health Check: ${{ needs.health-check.result }}
            - Data Update: ${{ needs.update-parts-data.result }}
            - Commit: ${{ needs.commit-updated-data.result }}
            
            ### å¯¾å¿œãŒå¿…è¦ãªé …ç›®
            - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
            - [ ] å¤–éƒ¨APIã®çŠ¶æ…‹ç¢ºèª
            - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºèª
            - [ ] æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å®Ÿè¡Œ
            
            ### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°
            [å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'data-update', 'priority: high']
            });

  # æˆåŠŸé€šçŸ¥ã¨ã‚µãƒãƒªãƒ¼
  success-summary:
    name: âœ… Success Summary
    runs-on: ubuntu-latest
    needs: [health-check, update-parts-data, commit-updated-data]
    if: success()
    steps:
      - name: âœ… Post success summary
        run: |
          echo "ğŸ‰ ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          echo "æ›´æ–°æ—¥æ™‚: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "æ¬¡å›æ›´æ–°: $(date -u -d '+1 day' +"%Y-%m-%d %H:%M:%S UTC")"
