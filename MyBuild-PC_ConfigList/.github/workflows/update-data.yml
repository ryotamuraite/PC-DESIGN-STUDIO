# PCæ§‹æˆãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ…Žé‡ã«å®Ÿè£… - æ®µéšŽçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

name: 'ðŸ”„ PC Data Auto Update'

on:
  # æ®µéšŽçš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
  schedule:
    # æ·±å¤œ2æ™‚ã«å®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
    - cron: '0 2 * * *'  # æ¯Žæ—¥ åˆå‰2æ™‚ (UTC)
    # é€±1å›žã®è©³ç´°æ›´æ–°
    - cron: '0 3 * * 0'  # æ¯Žé€±æ—¥æ›œ åˆå‰3æ™‚ (UTC)
  
  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:
    inputs:
      update_type:
        description: 'æ›´æ–°ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'mock'
        type: choice
        options:
          - mock        # ãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼ˆå®‰å…¨ï¼‰
          - limited     # åˆ¶é™ä»˜ãå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹
          - full        # æœ¬æ ¼å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæ…Žé‡ã«ï¼‰
      
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿéš›ã®æ›´æ–°ãªã—ï¼‰'
        required: false
        default: true
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
permissions:
  contents: write
  pull-requests: write

jobs:
  # ðŸ›¡ï¸ å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
  safety-check:
    name: 'ðŸ›¡ï¸ å®‰å…¨æ€§äº‹å‰ãƒã‚§ãƒƒã‚¯'
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      update_mode: ${{ steps.check.outputs.update_mode }}
    
    steps:
      - name: 'ðŸ“‹ ãƒã‚§ãƒƒã‚¯é …ç›®ç¢ºèª'
        id: check
        run: |
          echo "ðŸ” å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯é–‹å§‹..."
          
          # å®Ÿè¡Œæ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆæ·±å¤œæ™‚é–“å¸¯æŽ¨å¥¨ï¼‰
          current_hour=$(date -u +%H)
          echo "ç¾åœ¨æ™‚åˆ» (UTC): ${current_hour}æ™‚"
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å®‰å…¨ãªãƒ¢ãƒƒã‚¯å®Ÿè£…
          update_mode="mock"
          can_proceed="true"
          
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®è¨­å®šç¢ºèª
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            update_mode="${{ github.event.inputs.update_type }}"
            
            # å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
            if [ "$update_mode" != "mock" ]; then
              echo "âš ï¸ å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰: $update_mode"
              echo "ðŸ• æŽ¨å¥¨å®Ÿè¡Œæ™‚é–“: æ·±å¤œ2-5æ™‚ (UTC)"
              
              # å¹³æ—¥æ˜¼é–“ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™
              if [ $current_hour -ge 8 ] && [ $current_hour -le 18 ]; then
                echo "âŒ å¹³æ—¥æ˜¼é–“ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™"
                can_proceed="false"
              fi
            fi
          fi
          
          echo "can_proceed=$can_proceed" >> $GITHUB_OUTPUT
          echo "update_mode=$update_mode" >> $GITHUB_OUTPUT
          echo "âœ… å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # ðŸ“Š ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–  
  update-data:
    name: 'ðŸ“Š PCãƒ‡ãƒ¼ã‚¿æ›´æ–°'
    runs-on: ubuntu-latest
    needs: safety-check
    if: needs.safety-check.outputs.can_proceed == 'true'
    
    strategy:
      # å¤±æ•—æ™‚ã‚‚ç¶™ç¶šï¼ˆéƒ¨åˆ†çš„æˆåŠŸã‚’è¨±å¯ï¼‰
      fail-fast: false
      matrix:
        data_type: ['prices', 'stock', 'new_products']
    
    steps:
      - name: 'ðŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: 'âš™ï¸ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          npm ci
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: 'ðŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Ÿè¡Œ'
        env:
          # ç’°å¢ƒå¤‰æ•°ï¼ˆæ®µéšŽçš„ã«è¿½åŠ ï¼‰
          UPDATE_MODE: ${{ needs.safety-check.outputs.update_mode }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          DATA_TYPE: ${{ matrix.data_type }}
          
          # å¤–éƒ¨APIè¨­å®šï¼ˆå®‰å…¨ã«ç®¡ç†ï¼‰
          # KAKAKU_API_KEY: ${{ secrets.KAKAKU_API_KEY }}
          # AMAZON_API_KEY: ${{ secrets.AMAZON_API_KEY }}
          # RAKUTEN_API_KEY: ${{ secrets.RAKUTEN_API_KEY }}
          
        run: |
          echo "ðŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹: $DATA_TYPE"
          echo "ðŸ“‹ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰: $UPDATE_MODE"
          echo "ðŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: $DRY_RUN"
          
          # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          npm run update-data -- \
            --type="$DATA_TYPE" \
            --mode="$UPDATE_MODE" \
            --dry-run="$DRY_RUN"

      - name: 'ðŸ“ˆ æ›´æ–°çµæžœç¢ºèª'
        run: |
          echo "ðŸ“Š æ›´æ–°çµæžœã‚µãƒžãƒªãƒ¼"
          
          # æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ -f "data/update-results.json" ]; then
            echo "âœ… æ›´æ–°çµæžœãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨"
            cat data/update-results.json | jq -r '.summary'
          else
            echo "â„¹ï¸ æ›´æ–°çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰"
          fi
          
          # Gitå·®åˆ†ç¢ºèª
          if git diff --quiet; then
            echo "ðŸ“ å¤‰æ›´ãªã—"
          else
            echo "ðŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git diff --name-only
          fi

      - name: 'ðŸ’¾ å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆ'
        if: env.DRY_RUN != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if ! git diff --quiet; then
            echo "ðŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
            git add .
            git commit -m "ðŸ¤– è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${{ matrix.data_type }} (${{ github.run_number }})"
            git push
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          else
            echo "ðŸ“ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãªã—"
          fi

  # ðŸ“Š æ›´æ–°çµæžœã‚µãƒžãƒªãƒ¼
  summary:
    name: 'ðŸ“Š æ›´æ–°çµæžœã‚µãƒžãƒªãƒ¼'
    runs-on: ubuntu-latest
    needs: [safety-check, update-data]
    if: always()
    
    steps:
      - name: 'ðŸ“‹ å®Ÿè¡Œçµæžœã¾ã¨ã‚'
        run: |
          echo "## ðŸ”„ PCæ§‹æˆãƒ‡ãƒ¼ã‚¿æ›´æ–°çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**æ›´æ–°ãƒ¢ãƒ¼ãƒ‰**: ${{ needs.safety-check.outputs.update_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯**: ${{ needs.safety-check.outputs.can_proceed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.safety-check.outputs.can_proceed }}" = "true" ]; then
            echo "âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æ­£å¸¸å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šåœæ­¢" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹é…æ…®äº‹é …" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…æ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ·±å¤œæ™‚é–“å¸¯å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ®µéšŽçš„å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… BOTå¯¾ç­–å®Ÿè£…æ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
