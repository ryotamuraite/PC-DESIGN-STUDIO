# MyBuild PC ConfigList - CI/CD Pipeline
# è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†GitHub Actionsè¨­å®š

name: ğŸš€ Build & Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  lint-and-typecheck:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Run ESLint
        run: npm run lint

      - name: ğŸ” TypeScript type check
        run: npx tsc --noEmit

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 7

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for production
        run: npm run build

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: mybuild-pc-config.example.com # å¿…è¦ã«å¿œã˜ã¦ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®š

  # PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  preview-deploy:
    name: ğŸ”„ Deploy Preview
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for preview
        run: npm run build

      - name: ğŸ”„ Deploy to preview environment
        run: |
          echo "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†"
          echo "PR #${{ github.event.number }} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ"
          # å®Ÿéš›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 

  # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰
  update-data:
    name: ğŸ“Š Update Part Data
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ“Š Update parts database
        run: |
          echo "ãƒ‘ãƒ¼ãƒ„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°å‡¦ç†"
          echo "ä¾¡æ ¼æƒ…å ±ã®å–å¾—ãƒ»æ›´æ–°ã‚’å®Ÿè¡Œ"
          # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã“ã“ã«è¿½åŠ 

      - name: ğŸ’¾ Commit updated data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "ğŸ“Š Auto-update parts data [skip ci]"
          git push

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆæ¯æ—¥åˆå‰2æ™‚ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼‰
on:
  schedule:
    - cron: '0 2 * * *'  # UTC 2:00 AM (JST 11:00 AM)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
